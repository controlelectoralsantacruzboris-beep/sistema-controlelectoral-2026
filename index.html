<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Mapa Electoral 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
#map { height:100vh; }

.controls{
position:absolute;
top:15px;
left:50%;
transform:translateX(-50%);
z-index:1000;
display:flex;
gap:10px;
flex-wrap:wrap;
justify-content:center;
}

.controls input, .controls select{
padding:8px 12px;
border-radius:20px;
border:1px solid #ccc;
font-size:13px;
}

.suggestions{
position:absolute;
top:55px;
left:50%;
transform:translateX(-50%);
background:white;
width:300px;
max-height:200px;
overflow-y:auto;
border-radius:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.2);
z-index:1000;
}

.suggestions div{
padding:8px;
cursor:pointer;
}

.suggestions div:hover{
background:#f0f0f0;
}
</style>
</head>
<body>

<div class="controls">
<input type="text" id="searchInput" placeholder="Buscar recinto...">

<select id="filtroModo">
<option value="recinto">Recintos 2026</option>
<option value="CON2021">CON2021</option>
<option value="Dip20251V">Dip20251V</option>
<option value="20252V">20252V</option>
</select>
</div>

<div id="suggestions" class="suggestions"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// ===== MAPA BASE (centrado por defecto en Santa Cruz) =====
var map = L.map('map').setView([-17.7833, -63.1821], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19
}).addTo(map);

var capaDistritos = L.layerGroup().addTo(map);
var capaRecintos = L.layerGroup().addTo(map);

var markers = [];

// ===== GENERADOR DE COLOR AUTOMATICO =====
function generarColor(texto){
if(!texto) return "#007bff";

let hash = 0;
for(let i=0;i<texto.length;i++){
hash = texto.charCodeAt(i) + ((hash<<5)-hash);
}

let color = "#";
for(let i=0;i<3;i++){
let value = (hash >> (i*8)) & 255;
color += ("00"+value.toString(16)).substr(-2);
}
return color;
}

// =======================
// CARGAR UV
// =======================

fetch("./uv.geojson")
.then(r=>{
if(!r.ok) throw new Error("No se pudo cargar uv.geojson");
return r.json();
})
.then(data=>{

L.geoJSON(data,{
style:function(feature){

let pob = Number(feature.properties.poblacion)||0;
let opacity = 0.2;

if(pob <= 1000){
opacity = 0.2;
}else if(pob <= 4500){
opacity = 0.4;
}else if(pob <= 8000){
opacity = 0.6;
}else if(pob <= 13000){
opacity = 0.8;
}else{
opacity = 1.0;
}

return{
color:"#444",
weight:1,
fillColor:"#ff0000",
fillOpacity:opacity
};

}
}).addTo(capaDistritos);

})
.catch(e=>console.error("ERROR UV:",e));

// =======================
// CARGAR RECINTOS
// =======================

fetch("./recintos2026.json")
.then(r=>{
if(!r.ok) throw new Error("No se pudo cargar recintos2026.json");
return r.json();
})
.then(data=>{

let maxHab = Math.max(...data.map(d=>Number(d.Habilitados2026)||0));
if(maxHab===0) maxHab=1;

data.forEach(d=>{

let lat = Number(d.Latitud);
let lng = Number(d.Longitud);
if(isNaN(lat)||isNaN(lng)) return;

let size = (Number(d.Habilitados2026)||0)/maxHab * 25;

let marker = L.circleMarker([lat,lng],{
radius:4+size,
fillColor:"#007bff",
color:"#000",
weight:1,
fillOpacity:0.9
});

marker.bindPopup(`
<b>üè´ ${d.Recinto}</b><br><br>
üë§ <b>Jefe:</b> ${d.JefesdeRecinto || "N/D"}<br>
üó≥ <b>Habilitados:</b> ${d.Habilitados2026 || 0}<br>
ü™ë <b>Mesas 2026:</b> ${d["Cantidad Mesas 2026"] || 0}<br>
üèõ <b>Distrito:</b> ${d.Distrito || ""}<br>
üìä <b>CON2021:</b> ${d.CON2021 || ""}<br>
üó≥ <b>Dip20251V:</b> ${d.Dip20251V || ""}<br>
üìå <b>20252V:</b> ${d["20252V"] || ""}
`);

markers.push({data:d, marker:marker});

});

aplicarColores();

})
.catch(e=>console.error("ERROR RECINTOS:",e));

// =======================
// CAMBIO DE MODO
// =======================

document.getElementById("filtroModo").addEventListener("change", aplicarColores);

function aplicarColores(){

capaRecintos.clearLayers();

let modo = document.getElementById("filtroModo").value;

markers.forEach(obj=>{

let d = obj.data;
let color = "#007bff";

if(modo === "recintos"){
color = generarColor(d.Distrito);
}else{
color = generarColor(d[modo]);
}

obj.marker.setStyle({fillColor:color});
obj.marker.addTo(capaRecintos);

});

capaRecintos.bringToFront();

}

// ===== BUSCADOR =====
var input=document.getElementById("searchInput");
var suggestions=document.getElementById("suggestions");

input.addEventListener("input",function(){

let texto=this.value.toLowerCase();
suggestions.innerHTML="";
if(texto.length<2) return;

markers
.filter(m=>m.data.Recinto.toLowerCase().includes(texto))
.slice(0,8)
.forEach(m=>{
let div=document.createElement("div");
div.innerText=m.data.Recinto;
div.onclick=function(){
map.setView(m.marker.getLatLng(),16);
m.marker.openPopup();
suggestions.innerHTML="";
input.value="";
};
suggestions.appendChild(div);
});

});

</script>
</body>
</html>