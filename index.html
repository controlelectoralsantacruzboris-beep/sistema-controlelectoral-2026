<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Mapa Electoral 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
#map { height:100vh; }

.controls{
position:absolute;
top:15px;
left:50%;
transform:translateX(-50%);
z-index:1000;
display:flex;
gap:10px;
flex-wrap:wrap;
justify-content:center;
}

.controls input, .controls select{
padding:8px 12px;
border-radius:20px;
border:1px solid #ccc;
font-size:13px;
}

.suggestions{
position:absolute;
top:55px;
left:50%;
transform:translateX(-50%);
background:white;
width:300px;
max-height:200px;
overflow-y:auto;
border-radius:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.2);
z-index:1000;
}

.suggestions div{
padding:8px;
cursor:pointer;
}

.suggestions div:hover{
background:#f0f0f0;
}
</style>
</head>
<body>

<div class="controls">
<input type="text" id="searchInput" placeholder="Buscar recinto...">

<select id="filtroGeneral">
<option value="">Seleccionar filtro</option>
</select>

</div>

<div id="suggestions" class="suggestions"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

var map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

var capaRecintos = L.layerGroup().addTo(map);
var capaDistritos = L.layerGroup().addTo(map);

var markers = [];

// ===== COLORES PARTIDOS =====
function colorPartido(p){
if(!p) return "#007bff";
p = p.toUpperCase();
if(p.includes("DEMOCRATAS")) return "green";
if(p.includes("PDC")) return "green";
if(p.includes("MAS-IPSP")) return "blue";
if(p.includes("NULO")) return "blue";
if(p.includes("UNIDAD")) return "yellow";
if(p.includes("LIBRE")) return "red";
if(p.includes("UCS")) return "cyan";
if(p.includes("C-A")) return "orange";
return "#007bff";
}

// =======================
// CARGAR POLIGONOS GEOJSON
// =======================

fetch("uv.geojson")
.then(r=>r.json())
.then(data=>{

L.geoJSON(data,{
style:function(feature){

let pob = Number(feature.properties.poblacion)||0;
let opacity = 0.2;

if(pob >= 0 && pob <= 1000){
    opacity = 0.2;
}else if(pob <= 4500){
    opacity = 0.4;
}else if(pob <= 8000){
    opacity = 0.6;
}else if(pob <= 13000){
    opacity = 0.8;
}else{
    opacity = 1.0;
}

return{
color:"#444",
weight:1,
fillColor:"#ff0000",
fillOpacity:opacity
};

},
onEachFeature:function(feature,layer){
layer.bindPopup(`
<b>Zona:</b> ${feature.properties.zona || ""}<br>
<b>Distrito:</b> ${feature.properties.distrito || ""}<br>
<b>PoblaciÃ³n:</b> ${feature.properties.poblacion || 0}
`);
}
}).addTo(capaDistritos);

capaDistritos.bringToBack();

});

// =======================
// CARGAR RECINTOS
// =======================

fetch("recintos2026.json")
.then(r=>r.json())
.then(data=>{

let maxHab = Math.max(...data.map(d=>Number(d.Habilitados2026)||0));
if(maxHab===0) maxHab=1;

let distritosSet = new Set();
let conSet = new Set();
let dipSet = new Set();
let v2025Set = new Set();

data.forEach(d=>{

distritosSet.add(d.Distrito);
conSet.add(d.CON2021);
dipSet.add(d.Dip20251V);
v2025Set.add(d["20252V"]);

let lat = Number(d.Latitud);
let lng = Number(d.Longitud);
if(isNaN(lat)||isNaN(lng)) return;

let size = (Number(d.Habilitados2026)||0)/maxHab * 25;

let marker = L.circleMarker([lat,lng],{
radius:4+size,
fillColor:"#007bff",
color:"#000",
weight:1,
fillOpacity:0.85
});

marker.bindPopup(`
<b>ğŸ« ${d.Recinto}</b><br><br>
ğŸ‘¤ <b>Jefe:</b> ${d.JefesdeRecinto || "N/D"}<br>
ğŸ—³ <b>Habilitados:</b> ${d.Habilitados2026 || 0}<br>
ğŸª‘ <b>Mesas 2026:</b> ${d["Cantidad Mesas 2026"] || 0}<br>
ğŸ› <b>Distrito:</b> ${d.Distrito || ""}<br>
ğŸ“Š <b>CON2021:</b> ${d.CON2021 || ""}<br>
ğŸ—³ <b>Dip20251V:</b> ${d.Dip20251V || ""}<br>
ğŸ“Œ <b>20252V:</b> ${d["20252V"] || ""}
`);

markers.push({data:d, marker:marker});

});

llenarFiltroGeneral(distritosSet, conSet, dipSet, v2025Set);

centrarMapa();
aplicarFiltros();

});

// =======================
// FUNCIONES
// =======================

function llenarFiltroGeneral(distritos, con, dip, v2025){

let select = document.getElementById("filtroGeneral");

distritos.forEach(v=>{
if(v){
let opt=document.createElement("option");
opt.value="Distrito|"+v;
opt.text="Distrito: "+v;
select.appendChild(opt);
}
});

con.forEach(v=>{
if(v){
let opt=document.createElement("option");
opt.value="CON2021|"+v;
opt.text="CON2021: "+v;
select.appendChild(opt);
}
});

dip.forEach(v=>{
if(v){
let opt=document.createElement("option");
opt.value="Dip20251V|"+v;
opt.text="Dip20251V: "+v;
select.appendChild(opt);
}
});

v2025.forEach(v=>{
if(v){
let opt=document.createElement("option");
opt.value="20252V|"+v;
opt.text="20252V: "+v;
select.appendChild(opt);
}
});

}

function centrarMapa(){
let group=L.featureGroup(markers.map(m=>m.marker));
map.fitBounds(group.getBounds());
}

document.getElementById("filtroGeneral").addEventListener("change", aplicarFiltros);

function aplicarFiltros(){

capaRecintos.clearLayers();

let filtro = document.getElementById("filtroGeneral").value;

let tipo = null;
let valor = null;

if(filtro){
let partes = filtro.split("|");
tipo = partes[0];
valor = partes[1];
}

markers.forEach(obj=>{

let d=obj.data;
let mostrar=true;
let color="#007bff";

if(tipo && valor){

if(d[tipo] != valor){
mostrar=false;
}else{
color = colorPartido(d[tipo]);
}

}

if(mostrar){
obj.marker.setStyle({fillColor:color});
obj.marker.addTo(capaRecintos);
}

});

}

// ===== BUSCADOR =====
var input=document.getElementById("searchInput");
var suggestions=document.getElementById("suggestions");

input.addEventListener("input",function(){

let texto=this.value.toLowerCase();
suggestions.innerHTML="";
if(texto.length<2) return;

markers
.filter(m=>m.data.Recinto.toLowerCase().includes(texto))
.slice(0,8)
.forEach(m=>{
let div=document.createElement("div");
div.innerText=m.data.Recinto;
div.onclick=function(){
map.setView(m.marker.getLatLng(),16);
m.marker.openPopup();
suggestions.innerHTML="";
input.value="";
};
suggestions.appendChild(div);
});

});

</script>
</body>
</html>