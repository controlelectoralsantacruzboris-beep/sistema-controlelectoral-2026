<script>

// ================= MAPA =================

var map = L.map('map').setView([-17.7833, -63.1821], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ================= COLORES DISTRITO =================

function getColorDistrito(d) {
    const colores = {
        1:"#e41a1c",2:"#377eb8",3:"#4daf4a",4:"#984ea3",5:"#ff7f00",
        6:"#ffff33",7:"#a65628",8:"#f781bf",9:"#999999",10:"#66c2a5",
        11:"#fc8d62",12:"#8da0cb",13:"#e78ac3",14:"#a6d854"
    };
    return colores[d] || "#444";
}

// ================= COLORES POBLACION UV =================

function getColorPoblacion(p) {
    return p > 5000 ? '#800026' :
           p > 4000 ? '#BD0026' :
           p > 3000 ? '#E31A1C' :
           p > 2000 ? '#FC4E2A' :
           p > 1000 ? '#FD8D3C' :
           p > 500  ? '#FEB24C' :
                      '#FED976';
}

// ================= CAPAS =================

let capaUV = L.layerGroup().addTo(map);
let capaRecintos = L.layerGroup().addTo(map);

let todosRecintos = [];

// ================= UV =================

fetch('https://raw.githubusercontent.com/controlelectoralsantacruzboris-beep/sistema-controlelectoral-2026/main/csvjsondistritos.json')
.then(res => res.json())
.then(data => {

    data.forEach(item => {

        if(!item.WKT) return;

        let coordsText = item.WKT
            .replace("POLYGON ((", "")
            .replace("))", "");

        let puntos = coordsText.split(",").map(c => {
            let parts = c.trim().split(" ");
            return [parseFloat(parts[1]), parseFloat(parts[0])];
        });

        L.polygon(puntos, {
            color: "#333",
            weight: 1,
            fillColor: getColorPoblacion(item.poblacion),
            fillOpacity: 0.5
        })
        .bindPopup(
            "<b>Distrito:</b> " + item.distrito + "<br>" +
            "<b>UV:</b> " + item.zona + "<br>" +
            "<b>Poblaci√≥n:</b> " + item.poblacion
        )
        .addTo(capaUV);

    });

});

// ================= RECINTOS =================

fetch('https://raw.githubusercontent.com/controlelectoralsantacruzboris-beep/sistema-controlelectoral-2026/main/recintos2026.json')
.then(res => res.json())
.then(data => {

    data.forEach(r => {

        if(!r.Latitud || !r.Longitud) return;

        let distritoNumero = 0;

        if(r.Distrito){
            distritoNumero = parseInt(
                r.Distrito.replace("DISTRITO","").trim()
            );
        }

        let marker = L.circleMarker(
            [parseFloat(r.Latitud), parseFloat(r.Longitud)],
            {
                radius: 7,
                fillColor: getColorDistrito(distritoNumero),
                color: "#000",
                weight: 1,
                fillOpacity: 0.9
            }
        );

        marker.feature = {
            properties: {
                name: r.Nombre
            }
        };

        marker.bindPopup(
            "<b>" + r.Nombre + "</b><br>" +
            r.Distrito + "<br>" +
            (r.Ganador ? "<b>Ganador:</b> " + r.Ganador : "")
        );

        marker.addTo(capaRecintos);

        todosRecintos.push({
            marker: marker,
            ganador: r.Ganador
        });

    });

    // ===== BUSCADOR TIPO GOOGLE =====

    var searchControl = new L.Control.Search({
        layer: capaRecintos,
        propertyName: 'name',
        initial: false,
        zoom: 17,
        marker: false,
        autoCollapse: true,
        textPlaceholder: 'Buscar recinto...'
    });

    searchControl.on('search:locationfound', function(e) {
        e.layer.openPopup();
    });

    map.addControl(searchControl);

});

// ================= FILTRO POR GANADOR =================

function filtrarGanador(nombreGanador) {

    capaRecintos.clearLayers();

    todosRecintos.forEach(r => {

        if(!nombreGanador || r.ganador === nombreGanador){
            r.marker.addTo(capaRecintos);
        }

    });

}

</script>