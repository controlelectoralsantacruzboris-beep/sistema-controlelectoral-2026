<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Electoral SCZ 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
}

#map{
    height:100vh;
}

/* BUSCADOR */
.buscador-container{
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    z-index:1000;
    width:380px;
}

#buscadorRecinto{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:none;
    font-size:15px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

#sugerencias{
    background:white;
    max-height:220px;
    overflow-y:auto;
    border-radius:10px;
    margin-top:4px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

.sugerencia-item{
    padding:10px;
    cursor:pointer;
    border-bottom:1px solid #eee;
}

.sugerencia-item:hover{
    background:#f1f1f1;
}
</style>
</head>

<body>

<div class="buscador-container">
    <input type="text" id="buscadorRecinto" placeholder="üîé Buscar recinto..." autocomplete="off">
    <div id="sugerencias"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

let map = L.map('map').setView([-17.78, -63.18], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

let recintosData = [];
let marcadores = [];
let maxPoblacion = 0;

fetch("recintos2026.json")
.then(res => res.json())
.then(data => {

    recintosData = data;

    // Calcular m√°ximo de poblaci√≥n
    data.forEach(r => {
        let poblacion = parseInt(r.Habilitados_2026 || 0);
        if(poblacion > maxPoblacion){
            maxPoblacion = poblacion;
        }
    });

    cargarRecintos(data);
    iniciarBuscador();
});

function intensidadColor(valor){
    let intensidad = valor / maxPoblacion;

    // Gradiente rojo (m√°s poblaci√≥n = m√°s intenso)
    let rojo = Math.floor(255 * intensidad);
    let verde = Math.floor(150 * (1 - intensidad));

    return `rgb(${rojo},${verde},0)`;
}

function cargarRecintos(data){

    marcadores.forEach(m => map.removeLayer(m));
    marcadores = [];

    data.forEach(r => {

        if(!r.Latitud || !r.Longitud) return;

        let poblacion = parseInt(r.Habilitados_2026 || 0);

        let marker = L.circleMarker(
            [parseFloat(r.Latitud), parseFloat(r.Longitud)],
            {
                radius: 9,
                fillColor: intensidadColor(poblacion),
                color: "#000",
                weight: 1,
                fillOpacity: 0.85
            }
        ).addTo(map);

        marker.bindPopup(`
            <div style="font-size:14px">
            <b style="font-size:15px">${r.NombreRecinto}</b><br><br>
            üìç Distrito: ${r.Distrito || "-"}<br>
            üë• Jefes de Recinto: ${r.JefesDeRecinto || "-"}<br>
            üó≥ Mesas 2026: ${r.Mesas_2026 || "-"}<br>
            üë§ Habilitados 2026: <b>${r.Habilitados_2026 || 0}</b><br><br>
            üèÜ <b>Ganadores:</b><br>
            ‚Ä¢ 2021: ${r.AA || "-"}<br>
            ‚Ä¢ 2022: ${r.AB || "-"}<br>
            ‚Ä¢ 2025: ${r.AC || "-"}
            </div>
        `);

        marcadores.push(marker);
    });
}

/* =========================
   BUSCADOR TIPO GOOGLE
========================= */

function iniciarBuscador(){

    const input = document.getElementById("buscadorRecinto");
    const sugerencias = document.getElementById("sugerencias");

    input.addEventListener("input", function(){

        let valor = this.value.toLowerCase();
        sugerencias.innerHTML = "";

        if(valor.length < 2) return;

        let resultados = recintosData.filter(r =>
            r.NombreRecinto &&
            r.NombreRecinto.toLowerCase().includes(valor)
        ).slice(0,10);

        resultados.forEach(r => {

            let div = document.createElement("div");
            div.className = "sugerencia-item";
            div.innerText = r.NombreRecinto;

            div.onclick = function(){
                seleccionarRecinto(r);
            };

            sugerencias.appendChild(div);
        });
    });

    input.addEventListener("keypress", function(e){
        if(e.key === "Enter"){

            let resultado = recintosData.find(r =>
                r.NombreRecinto &&
                r.NombreRecinto.toLowerCase().includes(input.value.toLowerCase())
            );

            if(resultado){
                seleccionarRecinto(resultado);
            }
        }
    });
}

function seleccionarRecinto(r){

    document.getElementById("sugerencias").innerHTML = "";
    document.getElementById("buscadorRecinto").value = r.NombreRecinto;

    let lat = parseFloat(r.Latitud);
    let lng = parseFloat(r.Longitud);

    map.setView([lat,lng], 16);

    marcadores.forEach(m => {
        let pos = m.getLatLng();
        if(pos.lat == lat && pos.lng == lng){
            m.openPopup();
        }
    });
}

</script>

</body>
</html>