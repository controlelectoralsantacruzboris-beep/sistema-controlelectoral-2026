<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa Electoral SCZ 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; }
#map { height:100vh; width:100%; }

.control-box {
    position:absolute;
    top:10px;
    right:10px;
    z-index:1000;
    background:white;
    padding:10px;
    border-radius:8px;
    box-shadow:0 0 10px rgba(0,0,0,0.2);
    font-size:14px;
}

#buscador {
    position:absolute;
    top:10px;
    left:10px;
    z-index:1000;
    background:white;
    padding:8px;
    border-radius:8px;
    box-shadow:0 0 10px rgba(0,0,0,0.2);
}
</style>
</head>
<body>

<div id="map"></div>

<div id="buscador">
<input type="text" id="buscarRecinto" placeholder="Buscar recinto..." />
</div>

<div class="control-box">
<b>Color por:</b><br>
<select id="filtroGanador">
    <option value="distrito">Distrito</option>
    <option value="CON2021">CON2021</option>
    <option value="Dip20251V">Dip20251V</option>
    <option value="20252V">20252V</option>
</select>
</div>

<script>

// ================= MAPA =================
var map = L.map('map').setView([-17.7833, -63.1821], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
}).addTo(map);

var recintosLayer = [];

// ================= COLORES =================
function colorDistrito(d){
    return d==1?"#e41a1c":
           d==2?"#377eb8":
           d==3?"#4daf4a":
           d==4?"#984ea3":
           d==5?"#ff7f00":
           d==6?"#ffff33":
           d==7?"#a65628":
           d==8?"#f781bf":
           d==9?"#999999":
           "#000";
}

function colorPartido(p){
    if(!p) return "#666";
    p=p.toUpperCase();

    if(p.includes("C-A")) return "orange";
    if(p.includes("UCS")) return "#00cfff";
    if(p.includes("NULO")) return "blue";
    if(p.includes("MAS")) return "#0033cc";
    if(p.includes("PDC")) return "green";
    if(p.includes("DEMOCRATAS")) return "green";
    if(p.includes("UNIDAD")) return "yellow";
    if(p.includes("LIBRE")) return "red";

    return "#888";
}

// ================= UV =================
fetch("csvjsondistritos.json")
.then(r=>r.json())
.then(data=>{
    data.forEach(zona=>{
        var coords = zona.WKT
            .replace("POLYGON ((","")
            .replace("))","")
            .split(",")
            .map(c=>{
                var p=c.trim().split(" ");
                return [parseFloat(p[1]),parseFloat(p[0])];
            });

        L.polygon(coords,{
            color:"#444",
            weight:1,
            fillColor:colorDistrito(zona.distrito),
            fillOpacity:0.15
        }).addTo(map)
        .bindPopup(
            "<b>UV:</b> "+zona.zona+
            "<br><b>Distrito:</b> "+zona.distrito+
            "<br><b>Poblaci√≥n:</b> "+zona.poblacion
        );
    });
});

// ================= RECINTOS =================
fetch("recintos2026.json")
.then(r=>r.json())
.then(data=>{

    data.forEach(r=>{

        // Detectar nombres posibles de lat/lng
        var lat = r.lat || r.Lat || r.latitud || r.Latitud;
        var lng = r.lng || r.Lng || r.longitud || r.Longitud;

        if(!lat || !lng) return;

        var habilitados = parseInt(r.Habilitados2026)||0;
        var radio = Math.sqrt(habilitados)*0.6;

        var marker = L.circleMarker([lat,lng],{
            radius:radio,
            fillColor:colorDistrito(r.DISTRITO),
            color:"#000",
            weight:1,
            fillOpacity:0.8
        }).addTo(map);

        marker.datos=r;

        marker.bindPopup(
            "<b>"+r.Recinto+"</b>"+
            "<br><b>Distrito:</b> "+r.DISTRITO+
            "<br><b>Mesas:</b> "+r["Cantidad Mesas 2026"]+
            "<br><b>Habilitados:</b> "+habilitados+
            "<br><br><b>CON2021:</b> "+(r.CON2021||"-")+
            "<br><b>Dip20251V:</b> "+(r.Dip20251V||"-")+
            "<br><b>20252V:</b> "+(r["20252V"]||"-")
        );

        recintosLayer.push(marker);
    });
});

// ================= FILTRO =================
document.getElementById("filtroGanador")
.addEventListener("change",function(){

    var val=this.value;

    recintosLayer.forEach(marker=>{
        if(val==="distrito"){
            marker.setStyle({fillColor:
                colorDistrito(marker.datos.DISTRITO)
            });
        }else{
            marker.setStyle({fillColor:
                colorPartido(marker.datos[val])
            });
        }
    });
});

// ================= BUSCADOR =================
document.getElementById("buscarRecinto")
.addEventListener("keyup",function(){

    var texto=this.value.toLowerCase();

    recintosLayer.forEach(marker=>{
        var nombre=(marker.datos.Recinto||"").toLowerCase();

        if(nombre.includes(texto)){
            marker.setStyle({opacity:1,fillOpacity:0.9});
        }else{
            marker.setStyle({opacity:0.2,fillOpacity:0.2});
        }
    });

});

</script>
</body>
</html>