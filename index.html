<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa Electoral 2026</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
#map { height: 100vh; }

.panel {
position:absolute;
top:10px;
right:10px;
z-index:1000;
background:white;
padding:10px;
border-radius:8px;
width:320px;
box-shadow:0 4px 12px rgba(0,0,0,0.25);
font-family:Arial;
}

.panel select, .panel input{
width:100%;
margin-bottom:6px;
padding:5px;
}

.suggestions{
max-height:200px;
overflow-y:auto;
border:1px solid #ccc;
}

.suggestion-item{
padding:6px;
cursor:pointer;
}

.suggestion-item:hover{
background:#f0f0f0;
}
</style>
</head>

<body>

<div class="panel">

<select id="filtroDistrito">
<option value="TODOS">Filtro Distrito</option>
</select>

<select id="filtroCON2021">
<option value="TODOS">Filtro CON2021</option>
</select>

<select id="filtroDip">
<option value="TODOS">Filtro Dip20251V</option>
</select>

<select id="filtro20252V">
<option value="TODOS">Filtro 20252V</option>
</select>

<input type="text" id="buscador" placeholder="Buscar recinto...">
<div id="suggestions" class="suggestions"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

var map = L.map('map').setView([-17.78,-63.18],12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'Â© OpenStreetMap'
}).addTo(map);

var capaDistritos = L.layerGroup().addTo(map);
var capaRecintos = L.layerGroup().addTo(map);

capaDistritos.bringToBack();

var datosRecintos=[];
var datosDistritos=[];
var marcadorBusqueda=null;


// ================= COLORES =================

function colorPartido(valor){
if(!valor) return "#999";
valor=valor.toUpperCase();
if(valor.includes("DEMOCRATAS")) return "green";
if(valor.includes("PDC")) return "green";
if(valor.includes("MAS")) return "blue";
if(valor.includes("NULO")) return "blue";
if(valor.includes("UNIDAD")) return "yellow";
if(valor.includes("LIBER")) return "red";
if(valor.includes("UCS")) return "cyan";
if(valor.includes("C-A")) return "orange";
return "#999";
}

function colorDistrito(d){
var n=parseInt(d.replace(/\D/g,'')) || 0;
var colores=["#1f77b4","#ff7f0e","#2ca02c","#d62728",
"#9467bd","#8c564b","#e377c2","#7f7f7f",
"#bcbd22","#17becf"];
return colores[n%10];
}


// ================= RADIO =================

function radioRecinto(valor){
valor = Number(valor);
if(isNaN(valor)) return 4;
return 5 + (valor/900);
}


// ================= PARSER WKT ROBUSTO =================

function parseWKT(wkt){

if(!wkt || typeof wkt !== "string") return [];

wkt = wkt.trim();

let multipolygon = wkt.startsWith("MULTIPOLYGON");
let limpio = wkt
.replace("MULTIPOLYGON(((","")
.replace("POLYGON ((","")
.replace("POLYGON((","")
.replace(/\)\)\)/g,"")
.replace(/\)\)/g,"");

let grupos = limpio.split("),(");
let resultado = [];

for(let g=0; g<grupos.length; g++){

let coords = grupos[g].split(",");
let latlngs=[];

for(let i=0;i<coords.length;i++){

let p = coords[i].trim().split(/\s+/);

if(p.length>=2){
let lng = parseFloat(p[0]);
let lat = parseFloat(p[1]);
if(!isNaN(lat) && !isNaN(lng)){
latlngs.push([lat,lng]);
}
}

}

if(latlngs.length>2){
resultado.push(latlngs);
}

}

return resultado;

}


// ================= DIBUJAR DISTRITOS =================

function dibujarDistritos(){

capaDistritos.clearLayers();

if(!datosDistritos || datosDistritos.length===0) return;

let maxPob=0;

for(let i=0;i<datosDistritos.length;i++){
let p = Number(datosDistritos[i].poblacion);
if(!isNaN(p) && p>maxPob) maxPob=p;
}

if(maxPob===0) maxPob=1;

for(let i=0;i<datosDistritos.length;i++){

let d = datosDistritos[i];

if(!d.WKT) continue;

let grupos = parseWKT(d.WKT);

for(let g=0; g<grupos.length; g++){

let intensidad = (Number(d.poblacion)||0)/maxPob;

L.polygon(grupos[g],{
color:"#000",
weight:1,
fillColor:"#ff0000",
fillOpacity:0.15 + intensidad*0.5
}).addTo(capaDistritos);

}

}

capaDistritos.bringToBack();

}


// ================= DIBUJAR RECINTOS =================

function dibujarRecintos(){

capaRecintos.clearLayers();

var fDist=document.getElementById("filtroDistrito").value;
var fCon=document.getElementById("filtroCON2021").value;
var fDip=document.getElementById("filtroDip").value;
var f52=document.getElementById("filtro20252V").value;

datosRecintos.forEach(r=>{

if(fDist!="TODOS" && r.Distrito!=fDist) return;
if(fCon!="TODOS" && r.CON2021!=fCon) return;
if(fDip!="TODOS" && r.Dip20251V!=fDip) return;
if(f52!="TODOS" && r["20252V"]!=f52) return;

var color="#3388ff";

if(fDist!="TODOS") color=colorDistrito(r.Distrito);
if(fCon!="TODOS") color=colorPartido(r.CON2021);
if(fDip!="TODOS") color=colorPartido(r.Dip20251V);
if(f52!="TODOS") color=colorPartido(r["20252V"]);

L.circleMarker([r.Latitud,r.Longitud],{
radius:radioRecinto(r.Habilitados2026),
fillColor:color,
color:"#222",
weight:1,
fillOpacity:0.9
})
.bindPopup("<b>"+r.Recinto+"</b>")
.addTo(capaRecintos);

});

}


// ================= FILTROS UNO POR UNO =================

document.querySelectorAll("select").forEach(select=>{
select.addEventListener("change",function(){

document.querySelectorAll("select").forEach(s=>{
if(s!==this) s.value="TODOS";
});

dibujarRecintos();

});
});


// ================= CARGAR DATOS =================

fetch("recintos2026.json")
.then(res=>res.json())
.then(data=>{
datosRecintos=data;

var distritos=[...new Set(data.map(r=>r.Distrito))];
var select=document.getElementById("filtroDistrito");

distritos.forEach(d=>{
var op=document.createElement("option");
op.value=d;
op.text=d;
select.appendChild(op);
});

dibujarRecintos();
});

fetch("csvjsondistritos.json")
.then(res=>res.json())
.then(data=>{
datosDistritos=data;
dibujarDistritos();
});

</script>

</body>
</html>