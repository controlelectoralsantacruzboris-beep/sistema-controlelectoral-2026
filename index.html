<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa Electoral 2026</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
#map { height: 100vh; }

.panel {
position:absolute;
top:10px;
right:10px;
z-index:1000;
background:white;
padding:10px;
border-radius:8px;
width:320px;
box-shadow:0 4px 12px rgba(0,0,0,0.25);
font-family:Arial;
}

.panel select, .panel input{
width:100%;
margin-bottom:6px;
padding:5px;
}

.suggestions{
max-height:200px;
overflow-y:auto;
border:1px solid #ccc;
}

.suggestion-item{
padding:6px;
cursor:pointer;
}

.suggestion-item:hover{
background:#f0f0f0;
}
</style>
</head>

<body>

<div class="panel">

<select id="filtroDistrito">
<option value="TODOS">Filtro Distrito</option>
</select>

<select id="filtroCON2021">
<option value="TODOS">Filtro CON2021</option>
</select>

<select id="filtroDip">
<option value="TODOS">Filtro Dip20251V</option>
</select>

<select id="filtro20252V">
<option value="TODOS">Filtro 20252V</option>
</select>

<input type="text" id="buscador" placeholder="Buscar recinto...">
<div id="suggestions" class="suggestions"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

var map = L.map('map').setView([-17.78,-63.18],12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'¬© OpenStreetMap'
}).addTo(map);

var capaRecintos = L.layerGroup().addTo(map);
var capaDistritos = L.layerGroup().addTo(map);

var datosRecintos=[];
var datosDistritos=[];
var marcadorBusqueda=null;


// ================= COLORES PARTIDOS =================

function colorPartido(valor){
if(!valor) return "#999";
valor=valor.toUpperCase();
if(valor.includes("DEMOCRATAS")) return "green";
if(valor.includes("PDC")) return "green";
if(valor.includes("MAS")) return "blue";
if(valor.includes("NULO")) return "blue";
if(valor.includes("UNIDAD")) return "yellow";
if(valor.includes("LIBRE")) return "red";
if(valor.includes("UCS")) return "cyan";
if(valor.includes("C-A")) return "orange";
return "#999";
}


// ================= RADIO BURBUJA =================

function radioRecinto(valor){
valor = Number(valor);
if(isNaN(valor)) return 4;
return 4 + (valor / 1000); 
}


// ================= COLOR DISTRITO =================

function colorDistrito(d){
var n=parseInt(d.replace(/\D/g,'')) || 0;
var colores=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
"#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
return colores[n%10];
}


// ================= CONVERTIR WKT =================

function wktToLatLng(wkt){

wkt = wkt.replace(/POLYGON\s*\(\(/,"")
         .replace(/\)\)/,"")
         .trim();

var coords = wkt.split(",");
var latlngs = [];

coords.forEach(c=>{
var parts = c.trim().split(/\s+/);
if(parts.length>=2){
latlngs.push([
parseFloat(parts[1]),
parseFloat(parts[0])
]);
}
});

return latlngs;
}


// ================= DIBUJAR DISTRITOS =================

function dibujarDistritos(){

capaDistritos.clearLayers();

var maxPob = 0;

datosDistritos.forEach(d=>{
if(Number(d.poblacion)>maxPob){
maxPob = Number(d.poblacion);
}
});

datosDistritos.forEach(d=>{

if(!d.WKT) return;
if(d.WKT.indexOf("POLYGON")==-1) return;

var latlngs = wktToLatLng(d.WKT);
if(latlngs.length==0) return;

var intensidad = Number(d.poblacion)/maxPob;

L.polygon(latlngs,{
color:"#000",
weight:1,
fillColor:"#ff0000",
fillOpacity:0.2 + intensidad*0.6
})
.bindPopup("Distrito "+d.distrito+
"<br>Poblaci√≥n: "+d.poblacion)
.addTo(capaDistritos);

});

}


// ================= DIBUJAR RECINTOS =================

function dibujarRecintos(){

capaRecintos.clearLayers();

var fDist=document.getElementById("filtroDistrito").value;
var fCon=document.getElementById("filtroCON2021").value;
var fDip=document.getElementById("filtroDip").value;
var f52=document.getElementById("filtro20252V").value;

datosRecintos.forEach(r=>{

if(fDist!="TODOS" && r.Distrito!=fDist) return;
if(fCon!="TODOS" && r.CON2021!=fCon) return;
if(fDip!="TODOS" && r.Dip20251V!=fDip) return;
if(f52!="TODOS" && r["20252V"]!=f52) return;

var color="#3388ff";

if(fDist!="TODOS") color=colorDistrito(r.Distrito);
if(fCon!="TODOS") color=colorPartido(r.CON2021);
if(fDip!="TODOS") color=colorPartido(r.Dip20251V);
if(f52!="TODOS") color=colorPartido(r["20252V"]);

L.circleMarker([r.Latitud,r.Longitud],{
radius:radioRecinto(r.Habilitados2026),
fillColor:color,
color:"#222",
weight:1,
fillOpacity:0.85
})
.bindPopup(`
<b>${r.Recinto}</b><br>
Distrito: ${r.Distrito}<br>
Zona: ${r.Zona}<br>
Circunscripci√≥n: ${r.circun}<br>
Municipio: ${r.Municipio}<br>
Provincia: ${r.Provincia}<br>
Habilitados 2025: ${r.Habilitados2025}<br>
Habilitados 2026: ${r.Habilitados2026}<br>
CON2021: ${r.CON2021}<br>
Dip20251V: ${r.Dip20251V}<br>
20252V: ${r["20252V"]}
`)
.addTo(capaRecintos);

});

}


// ================= BUSCADOR =================

function normalizar(t){
return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

document.getElementById("buscador").addEventListener("input",function(){

var texto=normalizar(this.value);
var cont=document.getElementById("suggestions");
cont.innerHTML="";
if(texto.length<2) return;

var coincidencias=datosRecintos.filter(r=>
normalizar(r.Recinto).includes(texto));

coincidencias.slice(0,15).forEach(r=>{

var div=document.createElement("div");
div.className="suggestion-item";
div.innerHTML="<b>"+r.Recinto+"</b><br><small>"+r.Distrito+"</small>";

div.onclick=function(){

map.setView([r.Latitud,r.Longitud],16);

if(marcadorBusqueda) map.removeLayer(marcadorBusqueda);

marcadorBusqueda=L.circleMarker([r.Latitud,r.Longitud],{
radius:15,color:"yellow",weight:3
}).addTo(map);

cont.innerHTML="";
};

cont.appendChild(div);

});

});


// ================= CARGAR DATOS =================

fetch("recintos2026.json")
.then(res=>res.json())
.then(data=>{
datosRecintos=data;

var distritosUnicos=[...new Set(data.map(r=>r.Distrito))];
var select=document.getElementById("filtroDistrito");

distritosUnicos.forEach(d=>{
var op=document.createElement("option");
op.value=d;
op.text=d;
select.appendChild(op);
});

dibujarRecintos();
});


fetch("csvjsondistritos.json")
.then(res=>res.json())
.then(data=>{
datosDistritos=data;
dibujarDistritos();
});


// üî• SOLO UN FILTRO ACTIVO
document.querySelectorAll("select").forEach(select=>{
select.addEventListener("change",function(){
document.querySelectorAll("select").forEach(s=>{
if(s!==this) s.value="TODOS";
});
dibujarRecintos();
});
});

</script>

</body>
</html>