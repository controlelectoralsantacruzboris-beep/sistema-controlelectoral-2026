<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa Electoral 2026</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
#map { height: 100vh; }

.panel {
position:absolute;
top:10px;
right:10px;
z-index:1000;
background:white;
padding:10px;
border-radius:8px;
width:320px;
box-shadow:0 4px 12px rgba(0,0,0,0.25);
font-family:Arial;
}

.panel select, .panel input{
width:100%;
margin-bottom:6px;
padding:5px;
}

.suggestions{
max-height:200px;
overflow-y:auto;
border:1px solid #ccc;
}

.suggestion-item{
padding:6px;
cursor:pointer;
}

.suggestion-item:hover{
background:#f0f0f0;
}
</style>
</head>

<body>

<div class="panel">

<select id="filtroDistrito">
<option value="TODOS">Filtro Distrito</option>
</select>

<select id="filtroCON2021">
<option value="TODOS">Filtro CON2021</option>
</select>

<select id="filtroDip">
<option value="TODOS">Filtro Dip20251V</option>
</select>

<select id="filtro20252V">
<option value="TODOS">Filtro 20252V</option>
</select>

<input type="text" id="buscador" placeholder="Buscar recinto...">
<div id="suggestions" class="suggestions"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

var map = L.map('map').setView([-17.78,-63.18],12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'Â© OpenStreetMap'
}).addTo(map);

var capaDistritos = L.layerGroup().addTo(map);
var capaRecintos = L.layerGroup().addTo(map);

/* ðŸ”¥ aseguramos que recintos estÃ©n encima */
capaRecintos.bringToFront();

var datosRecintos=[];
var datosDistritos=[];
var marcadorBusqueda=null;
var filtroActivo=null;


// ================= COLORES =================

function colorPartido(valor){
if(!valor) return "#999";
valor=valor.toUpperCase();
if(valor.includes("MAS")) return "blue";
if(valor.includes("UNIDAD")) return "yellow";
if(valor.includes("LIBRE")) return "red";
if(valor.includes("UCS")) return "cyan";
if(valor.includes("DEMOCRATAS")) return "green";
return "#999";
}

function colorDistrito(d){
var n=parseInt(d.replace(/\D/g,'')) || 0;
var colores=["#1f77b4","#ff7f0e","#2ca02c","#d62728",
"#9467bd","#8c564b","#e377c2","#7f7f7f",
"#bcbd22","#17becf"];
return colores[n%10];
}


// ================= RADIO BURBUJA =================

function radioRecinto(valor){
valor = Number(valor);
if(isNaN(valor)) return 4;
return 4 + (valor/800); 
}


// ================= WKT SOPORTA POLYGON Y MULTIPOLYGON =================

function wktToLatLng(wkt){

wkt = wkt.replace("MULTIPOLYGON(((","")
         .replace("POLYGON ((","")
         .replace("POLYGON((","")
         .replace(")))","")
         .replace("))","")
         .trim();

var coords = wkt.split(",");
var latlngs = [];

coords.forEach(c=>{
var parts = c.trim().split(/\s+/);
if(parts.length>=2){
latlngs.push([
parseFloat(parts[1]),
parseFloat(parts[0])
]);
}
});

return latlngs;
}


// ================= DIBUJAR DISTRITOS =================

function dibujarDistritos(){

capaDistritos.clearLayers();

var maxPob=0;

datosDistritos.forEach(d=>{
if(Number(d.poblacion)>maxPob){
maxPob=Number(d.poblacion);
}
});

datosDistritos.forEach(d=>{

if(!d.WKT) return;

var latlngs = wktToLatLng(d.WKT);
if(latlngs.length<3) return;

var intensidad = Number(d.poblacion)/maxPob;

L.polygon(latlngs,{
color:"#000",
weight:1,
fillColor:"#ff0000",
fillOpacity:0.15 + intensidad*0.5
})
.addTo(capaDistritos);

});

/* ðŸ”¥ aseguramos orden correcto */
capaDistritos.bringToBack();
capaRecintos.bringToFront();

}


// ================= DIBUJAR RECINTOS =================

function dibujarRecintos(){

capaRecintos.clearLayers();

datosRecintos.forEach(r=>{

if(filtroActivo==="Distrito" && r.Distrito!=document.getElementById("filtroDistrito").value) return;
if(filtroActivo==="CON2021" && r.CON2021!=document.getElementById("filtroCON2021").value) return;
if(filtroActivo==="Dip" && r.Dip20251V!=document.getElementById("filtroDip").value) return;
if(filtroActivo==="20252V" && r["20252V"]!=document.getElementById("filtro20252V").value) return;

var color="#3388ff";

if(filtroActivo==="Distrito") color=colorDistrito(r.Distrito);
if(filtroActivo==="CON2021") color=colorPartido(r.CON2021);
if(filtroActivo==="Dip") color=colorPartido(r.Dip20251V);
if(filtroActivo==="20252V") color=colorPartido(r["20252V"]);

L.circleMarker([r.Latitud,r.Longitud],{
radius:radioRecinto(r.Habilitados2026),
fillColor:color,
color:"#222",
weight:1,
fillOpacity:0.9
})
.addTo(capaRecintos);

});

capaRecintos.bringToFront();

}


// ================= FILTROS UNO POR UNO REAL =================

function activarFiltro(nombre, selectId){

filtroActivo = nombre;

/* resetear todos */
document.querySelectorAll("select").forEach(s=>s.value="TODOS");

/* activar solo el actual */
document.getElementById(selectId).value =
event.target.value;

dibujarRecintos();
}

document.getElementById("filtroDistrito")
.addEventListener("change",function(e){
if(this.value==="TODOS"){ filtroActivo=null; }
else filtroActivo="Distrito";
dibujarRecintos();
});

document.getElementById("filtroCON2021")
.addEventListener("change",function(){
if(this.value==="TODOS"){ filtroActivo=null; }
else filtroActivo="CON2021";
dibujarRecintos();
});

document.getElementById("filtroDip")
.addEventListener("change",function(){
if(this.value==="TODOS"){ filtroActivo=null; }
else filtroActivo="Dip";
dibujarRecintos();
});

document.getElementById("filtro20252V")
.addEventListener("change",function(){
if(this.value==="TODOS"){ filtroActivo=null; }
else filtroActivo="20252V";
dibujarRecintos();
});


// ================= CARGAR DATOS =================

fetch("recintos2026.json")
.then(res=>res.json())
.then(data=>{
datosRecintos=data;

var distritos=[...new Set(data.map(r=>r.Distrito))];
var select=document.getElementById("filtroDistrito");

distritos.forEach(d=>{
var op=document.createElement("option");
op.value=d;
op.text=d;
select.appendChild(op);
});

dibujarRecintos();
});

fetch("csvjsondistritos.json")
.then(res=>res.json())
.then(data=>{
datosDistritos=data;
dibujarDistritos();
});

</script>
</body>
</html>