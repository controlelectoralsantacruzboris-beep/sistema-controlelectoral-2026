<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa Electoral SCZ 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

<style>
html, body {
    height: 100%;
    margin: 0;
}

#map {
    width: 100%;
    height: 100vh;
}

.filtro-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    padding: 8px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div id="map"></div>

<div class="filtro-container">
    <select onchange="filtrarGanador(this.value)">
        <option value="">Todos</option>
        <option value="LIBRE">LIBRE</option>
        <option value="CA">CA</option>
    </select>
</div>

<script>

document.addEventListener("DOMContentLoaded", function() {

// ================= MAPA =================

var map = L.map('map').setView([-17.7833, -63.1821], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ================= COLORES =================

function getColorDistrito(d) {
    const colores = {
        1:"#e41a1c",2:"#377eb8",3:"#4daf4a",4:"#984ea3",5:"#ff7f00",
        6:"#ffff33",7:"#a65628",8:"#f781bf",9:"#999999",10:"#66c2a5",
        11:"#fc8d62",12:"#8da0cb",13:"#e78ac3",14:"#a6d854"
    };
    return colores[d] || "#444";
}

function getColorPoblacion(p) {
    return p > 5000 ? '#800026' :
           p > 4000 ? '#BD0026' :
           p > 3000 ? '#E31A1C' :
           p > 2000 ? '#FC4E2A' :
           p > 1000 ? '#FD8D3C' :
           p > 500  ? '#FEB24C' :
                      '#FED976';
}

// ================= CAPAS =================

let capaUV = L.layerGroup().addTo(map);
let capaRecintos = L.layerGroup().addTo(map);
let todosRecintos = [];

// ================= UV (POLIGONOS) =================

fetch('https://raw.githubusercontent.com/controlelectoralsantacruzboris-beep/sistema-controlelectoral-2026/main/csvjsondistritos.json')
.then(res => res.json())
.then(data => {

    data.forEach(item => {

        if(!item.WKT) return;

        let coordsText = item.WKT
            .replace("POLYGON ((", "")
            .replace("))", "");

        let puntos = coordsText.split(",").map(c => {
            let parts = c.trim().split(" ");
            return [parseFloat(parts[1]), parseFloat(parts[0])];
        });

        L.polygon(puntos, {
            color: "#333",
            weight: 1,
            fillColor: getColorPoblacion(item.poblacion),
            fillOpacity: 0.5
        })
        .bindPopup(
            "<b>Distrito:</b> " + item.distrito +
            "<br><b>UV:</b> " + item.zona +
            "<br><b>Población:</b> " + item.poblacion +
            "<br><b>Circunscripción:</b> " + item.circuns
        )
        .addTo(capaUV);

    });

})
.catch(err => console.log("Error UV:", err));

// ================= RECINTOS =================

fetch('https://raw.githubusercontent.com/controlelectoralsantacruzboris-beep/sistema-controlelectoral-2026/main/recintos2026.json')
.then(res => res.json())
.then(data => {

    data.forEach(r => {

        if(!r.Latitud || !r.Longitud) return;

        let distritoNumero = 0;

        if(r.Distrito){
            distritoNumero = parseInt(
                r.Distrito.replace("DISTRITO","").trim()
            );
        }

        let habilitados = parseInt(r.Habilitados || 0);

        let marker = L.circleMarker(
            [parseFloat(r.Latitud), parseFloat(r.Longitud)],
            {
                radius: 7,
                fillColor: getColorDistrito(distritoNumero),
                color: "#000",
                weight: 1,
                fillOpacity: 0.9
            }
        );

        marker.feature = {
            properties: {
                name: r.Recinto
            }
        };

        marker.bindPopup(
            "<b>"+ (r.Recinto || "-") +"</b>"+
            "<br><b>"+ (r.Distrito || "-") +"</b>"+
            "<br><b>Zona:</b> "+ (r.Zona || "-") +
            "<br><b>Municipio:</b> "+ (r.Municipio || "-") +
            "<br><b>Mesas 2026:</b> "+ (r["Cantidad Mesas 2026"] || "-") +
            "<br><b>Habilitados:</b> "+ habilitados +
            "<hr>"+
            "<b>CON2021:</b> "+ (r.CON2021 || "-") +
            "<br><b>Dip20251V:</b> "+ (r.Dip20251V || "-") +
            "<br><b>20252V:</b> "+ (r["20252V"] || "-")
        );

        marker.addTo(capaRecintos);

        todosRecintos.push({
            marker: marker,
            ganador: r["20252V"]
        });

    });

    // ===== BUSCADOR TIPO GOOGLE =====

    var searchControl = new L.Control.Search({
        layer: capaRecintos,
        propertyName: 'name',
        zoom: 17,
        marker: false,
        autoCollapse: true,
        textPlaceholder: 'Buscar recinto...'
    });

    searchControl.on('search:locationfound', function(e) {
        e.layer.openPopup();
    });

    map.addControl(searchControl);

})
.catch(err => console.log("Error Recintos:", err));

// ================= FILTRO POR GANADOR =================

window.filtrarGanador = function(nombreGanador) {

    capaRecintos.clearLayers();

    todosRecintos.forEach(r => {

        if(!nombreGanador || r.ganador === nombreGanador){
            r.marker.addTo(capaRecintos);
        }

    });

};

});

</script>

</body>
</html>