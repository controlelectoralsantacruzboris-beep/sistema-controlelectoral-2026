<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Mapa Electoral 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
#map { height:100vh; }

.controls{
position:absolute;
top:15px;
left:50%;
transform:translateX(-50%);
z-index:1000;
display:flex;
gap:10px;
flex-wrap:wrap;
justify-content:center;
}

.controls input, .controls select{
padding:8px 12px;
border-radius:20px;
border:1px solid #ccc;
font-size:13px;
}

.suggestions{
position:absolute;
top:55px;
left:50%;
transform:translateX(-50%);
background:white;
width:300px;
max-height:200px;
overflow-y:auto;
border-radius:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.2);
z-index:1000;
}

.suggestions div{
padding:8px;
cursor:pointer;
}

.suggestions div:hover{
background:#f0f0f0;
}
</style>
</head>
<body>

<div class="controls">
<input type="text" id="searchInput" placeholder="Buscar recinto...">
<select id="filtroDistrito"><option value="">Filtrar Distrito</option></select>
<select id="filtroCON2021"><option value="">Filtrar CON2021</option></select>
<select id="filtroDip20251V"><option value="">Filtrar Dip20251V</option></select>
<select id="filtro20252V"><option value="">Filtrar 20252V</option></select>
</div>

<div id="suggestions" class="suggestions"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

var map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

var capaRecintos = L.layerGroup().addTo(map);
var capaDistritos = L.layerGroup().addTo(map);

var markers = [];

// ===== COLORES PARTIDOS =====
function colorPartido(p){
if(!p) return "#007bff";
p = p.toUpperCase();
if(p.includes("DEMOCRATAS")) return "green";
if(p.includes("PDC")) return "green";
if(p.includes("MAS-IPSP")) return "blue";
if(p.includes("NULO")) return "blue";
if(p.includes("UNIDAD")) return "yellow";
if(p.includes("LIBRE")) return "red";
if(p.includes("UCS")) return "cyan";
if(p.includes("C-A")) return "orange";
return "#007bff";
}

// =======================
// CARGAR POLIGONOS GEOJSON
// =======================

fetch("uv.geojson")
.then(r=>r.json())
.then(data=>{

let maxPob = Math.max(...data.features.map(f=>Number(f.properties.poblacion)||0));
if(maxPob===0) maxPob=1;

L.geoJSON(data,{
style:function(feature){

let pob = Number(feature.properties.poblacion)||0;
let intensidad = pob/maxPob;

return{
color:"#444",
weight:1,
fillColor:"#ff0000",
fillOpacity:0.15 + intensidad*0.5
};

},
onEachFeature:function(feature,layer){
layer.bindPopup(`
<b>Zona:</b> ${feature.properties.zona || ""}<br>
<b>Distrito:</b> ${feature.properties.distrito || ""}<br>
<b>PoblaciÃ³n:</b> ${feature.properties.poblacion || 0}
`);
}
}).addTo(capaDistritos);

capaDistritos.bringToBack();

});

// =======================
// CARGAR RECINTOS
// =======================

fetch("recintos2026.json")
.then(r=>r.json())
.then(data=>{

let maxHab = Math.max(...data.map(d=>Number(d.Habilitados2026)||0));
if(maxHab===0) maxHab=1;

let distritosSet = new Set();
let conSet = new Set();
let dipSet = new Set();
let v2025Set = new Set();

data.forEach(d=>{

distritosSet.add(d.Distrito);
conSet.add(d.CON2021);
dipSet.add(d.Dip20251V);
v2025Set.add(d["20252V"]);

let lat = Number(d.Latitud);
let lng = Number(d.Longitud);
if(isNaN(lat)||isNaN(lng)) return;

let size = (Number(d.Habilitados2026)||0)/maxHab * 25;

let marker = L.circleMarker([lat,lng],{
radius:4+size,
fillColor:"#007bff",
color:"#000",
weight:1,
fillOpacity:0.85
});

marker.bindPopup(`
<b>ğŸ« ${d.Recinto}</b><br><br>
ğŸ‘¤ <b>Jefe:</b> ${d.JefesdeRecinto || "N/D"}<br>
ğŸ—³ <b>Habilitados:</b> ${d.Habilitados2026 || 0}<br>
ğŸª‘ <b>Mesas 2026:</b> ${d["Cantidad Mesas 2026"] || 0}<br>
ğŸ› <b>Distrito:</b> ${d.Distrito || ""}<br>
ğŸ“Š <b>CON2021:</b> ${d.CON2021 || ""}<br>
ğŸ—³ <b>Dip20251V:</b> ${d.Dip20251V || ""}<br>
ğŸ“Œ <b>20252V:</b> ${d["20252V"] || ""}
`);

markers.push({data:d, marker:marker});

});

llenarSelect("filtroDistrito", distritosSet);
llenarSelect("filtroCON2021", conSet);
llenarSelect("filtroDip20251V", dipSet);
llenarSelect("filtro20252V", v2025Set);

centrarMapa();
aplicarFiltros();

});

// =======================
// FUNCIONES
// =======================

function llenarSelect(id,set){
let select=document.getElementById(id);
set.forEach(v=>{
if(v){
let opt=document.createElement("option");
opt.value=v;
opt.text=v;
select.appendChild(opt);
}
});
}

function centrarMapa(){
let group=L.featureGroup(markers.map(m=>m.marker));
map.fitBounds(group.getBounds());
}

document.querySelectorAll("select").forEach(sel=>{
sel.addEventListener("change",function(){
document.querySelectorAll("select").forEach(s=>{ if(s!==this) s.value=""; });
aplicarFiltros();
});
});

function aplicarFiltros(){

capaRecintos.clearLayers();

let fDistrito=document.getElementById("filtroDistrito").value;
let fCON=document.getElementById("filtroCON2021").value;
let fDip=document.getElementById("filtroDip20251V").value;
let f2025=document.getElementById("filtro20252V").value;

markers.forEach(obj=>{

let d=obj.data;
let mostrar=true;
let color="#007bff";

if(fDistrito && d.Distrito!==fDistrito) mostrar=false;

if(fCON){
if(d.CON2021!==fCON) mostrar=false;
color=colorPartido(d.CON2021);
}

if(fDip){
if(d.Dip20251V!==fDip) mostrar=false;
color=colorPartido(d.Dip20251V);
}

if(f2025){
if(d["20252V"]!==f2025) mostrar=false;
color=colorPartido(d["20252V"]);
}

if(mostrar){
obj.marker.setStyle({fillColor:color});
obj.marker.addTo(capaRecintos);
}

});

}

// ===== BUSCADOR =====
var input=document.getElementById("searchInput");
var suggestions=document.getElementById("suggestions");

input.addEventListener("input",function(){

let texto=this.value.toLowerCase();
suggestions.innerHTML="";
if(texto.length<2) return;

markers
.filter(m=>m.data.Recinto.toLowerCase().includes(texto))
.slice(0,8)
.forEach(m=>{
let div=document.createElement("div");
div.innerText=m.data.Recinto;
div.onclick=function(){
map.setView(m.marker.getLatLng(),16);
m.marker.openPopup();
suggestions.innerHTML="";
input.value="";
};
suggestions.appendChild(div);
});

});

</script>
</body>
</html>