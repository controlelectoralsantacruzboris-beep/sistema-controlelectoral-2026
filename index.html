<script>

// ============================
// MAPA BASE
// ============================

var map = L.map('map').setView([-17.7833, -63.1821], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ============================
// COLORES POR DISTRITO
// ============================

function getColorDistrito(d) {
    const colores = {
        1:"#e41a1c",2:"#377eb8",3:"#4daf4a",4:"#984ea3",5:"#ff7f00",
        6:"#ffff33",7:"#a65628",8:"#f781bf",9:"#999999",10:"#66c2a5",
        11:"#fc8d62",12:"#8da0cb",13:"#e78ac3",14:"#a6d854"
    };
    return colores[d] || "#444";
}

// ============================
// ESCALA POR POBLACION (UV)
// ============================

function getColorPoblacion(p) {
    return p > 5000 ? '#800026' :
           p > 4000 ? '#BD0026' :
           p > 3000 ? '#E31A1C' :
           p > 2000 ? '#FC4E2A' :
           p > 1000 ? '#FD8D3C' :
           p > 500  ? '#FEB24C' :
                      '#FED976';
}

// ============================
// CAPA UV (POLIGONOS)
// ============================

let capaUV = L.layerGroup().addTo(map);

fetch('https://raw.githubusercontent.com/controlelectoralsantacruzboris-beep/sistema-controlelectoral-2026/main/csvjsondistritos.json')
.then(res => res.json())
.then(data => {

    data.forEach(item => {

        if(!item.WKT) return;

        // Limpiar texto POLYGON
        let coordsText = item.WKT
            .replace("POLYGON ((", "")
            .replace("))", "");

        let puntos = coordsText.split(",").map(c => {
            let parts = c.trim().split(" ");
            return [parseFloat(parts[1]), parseFloat(parts[0])];
        });

        let poligono = L.polygon(puntos, {
            color: "#333",
            weight: 1,
            fillColor: getColorPoblacion(item.poblacion),
            fillOpacity: 0.55
        });

        poligono.bindPopup(`
            <b>Distrito:</b> ${item.distrito}<br>
            <b>UV (Zona):</b> ${item.zona}<br>
            <b>Población:</b> ${item.poblacion}<br>
            <b>Circunscripción:</b> ${item.circuns}
        `);

        poligono.addTo(capaUV);
    });

});

// ============================
// CAPA RECINTOS
// ============================

let capaRecintos = L.layerGroup().addTo(map);
let listaRecintos = [];

fetch('https://raw.githubusercontent.com/controlelectoralsantacruzboris-beep/sistema-controlelectoral-2026/main/recintos2026.json')
.then(res => res.json())
.then(data => {

    data.forEach(r => {

        if(!r.Latitud || !r.Longitud) return;

        // EXTRAER NUMERO DE "DISTRITO 10"
        let distritoNumero = parseInt(
            r.Distrito.replace("DISTRITO","").trim()
        );

        let marker = L.circleMarker([r.Latitud, r.Longitud], {
            radius: 8,
            fillColor: getColorDistrito(distritoNumero),
            color: "#000",
            weight: 1,
            fillOpacity: 0.9
        });

        marker.bindPopup(`
            <b>${r.Nombre}</b><br>
            ${r.Distrito}<br>
            Dirección: ${r.Direccion}
        `);

        marker.addTo(capaRecintos);

        listaRecintos.push({
            nombre: r.Nombre,
            marker: marker
        });

    });

});

// ============================
// BUSCADOR CON PREDICCION
// ============================

var searchControl = new L.Control.Search({
    layer: capaRecintos,
    propertyName: 'nombre',
    initial: false,
    zoom: 17,
    marker: false
});

searchControl.on('search:locationfound', function(e) {
    e.layer.openPopup();
});

map.addControl(searchControl);

</script>