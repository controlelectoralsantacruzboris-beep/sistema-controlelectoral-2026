<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Sistema Electoral 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Buscador Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.7/wicket.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.7/wicket-leaflet.min.js"></script>

<style>
body { margin:0; display:flex; font-family:Arial; overflow:hidden; }
#map { width:75%; height:100vh; }
#dashboard {
width:25%;
background:#1e1e1e;
color:white;
padding:15px;
overflow-y:auto;
}
#rankingRecintos{
max-height:300px;
overflow-y:auto;
margin-top:10px;
border-top:1px solid #444;
padding-top:10px;
}
#controls{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
z-index:1000;
background:white;
padding:12px;
border-radius:8px;
box-shadow:0 0 10px rgba(0,0,0,0.3);
}
#searchBox{
margin-top:8px;
width:100%;
padding:6px;
}
</style>
</head>
<body>

<div id="controls">
<b>Sistema Electoral 2026</b><br>
INFORMACION BORIS RAMIREZ<br>
<input type="text" id="searchBox" placeholder="ðŸ”Ž Buscar recinto...">
</div>

<div id="map"></div>

<div id="dashboard">
<h3>ðŸ“Š Dashboard</h3>
<b>Total Recintos:</b>
<div id="totalRecintos">0</div>
<b>Total Habilitados:</b>
<div id="totalHabilitados">0</div>
<hr>
<b>Ranking (Top 10)</b>
<div id="rankingRecintos"></div>
</div>

<script>

var map=L.map('map').setView([-17.7833,-63.1821],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

var layerUV=L.layerGroup().addTo(map);
var layerRecintos=L.layerGroup().addTo(map);

var recintosData=[];

// ===== FUNCIONES =====
function extraerNumeroDistrito(texto){
if(!texto) return null;
let m=texto.toString().match(/\d+/);
return m?parseInt(m[0]):null;
}

function colorDistrito(numero){
let colores=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
"#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf",
"#8B0000","#006400","#00008B","#FF8C00","#4B0082"];
return colores[(numero-1)%colores.length];
}

function colorUV(p){
if(p<=500) return "#ffe5e5";
if(p<=3500) return "#ff9999";
if(p<=7000) return "#ff4d4d";
if(p<=12000) return "#cc0000";
return "#660000";
}

function actualizarDashboard(){

let totalRecintos=recintosData.length;
let totalHab=0;

recintosData.forEach(r=> totalHab+=r.hab);

document.getElementById("totalRecintos").innerHTML=totalRecintos;
document.getElementById("totalHabilitados").innerHTML=totalHab.toLocaleString();

let ranking=[...recintosData]
.sort((a,b)=>b.hab-a.hab)
.slice(0,10);

let html="";
ranking.forEach(r=>{
html+=`<div>â€¢ ${r.nombre} (${r.hab.toLocaleString()})</div>`;
});

document.getElementById("rankingRecintos").innerHTML=html;
}

// ===== CARGAR UV =====
fetch("csvjsondistritos.json")
.then(res=>res.json())
.then(data=>{
data.forEach(item=>{
if(!item.WKT) return;

let w=new Wkt.Wkt();
w.read(item.WKT);

let poblacion=parseInt(item.poblacion)||0;
let distritoNum=extraerNumeroDistrito(item.distrito);

let poly=w.toObject({
color:distritoNum?colorDistrito(distritoNum):"#000",
weight:2,
fillColor:colorUV(poblacion),
fillOpacity:0.75
});

poly.bindPopup(`
<b>UV: ${item.zona||"-"}</b><br>
Distrito: ${item.distrito||"-"}<br>
Habitantes: ${poblacion.toLocaleString()}
`);

poly.addTo(layerUV);
});
})
.catch(e=>console.error("Error UV:",e));

// ===== CARGAR RECINTOS =====
fetch("recintos2026.json")
.then(res=>{
if(!res.ok) throw new Error("No se pudo cargar recintos");
return res.json();
})
.then(data=>{

console.log("Recintos cargados:",data.length);

let bounds=[];

data.forEach(row=>{

let lat=parseFloat(row.Latitud);
let lng=parseFloat(row.Longitud);
if(isNaN(lat)||isNaN(lng)) return;

let hab=parseFloat(row.Habilitados2026);
if(isNaN(hab)) hab=0;

let radio=Math.max(6,Math.sqrt(hab)/3);

let distritoNum=extraerNumeroDistrito(row.Distrito);
let color=distritoNum?colorDistrito(distritoNum):"#FFD700";

let marker=L.circleMarker([lat,lng],{
radius:radio,
fillColor:color,
color:color,
fillOpacity:0.9
}).addTo(layerRecintos);

marker.bindPopup(`
<b>${row.Recinto}</b><br>
Distrito: ${row.Distrito||"-"}<br>
Habilitados: ${hab.toLocaleString()}
`);

recintosData.push({
nombre:row.Recinto,
hab:hab,
marker:marker
});

bounds.push([lat,lng]);

});

if(bounds.length>0) map.fitBounds(bounds);

actualizarDashboard();

})
.catch(e=>console.error("Error recintos:",e));

// ===== BUSCADOR =====
document.getElementById("searchBox").addEventListener("input",function(){

let texto=this.value.toLowerCase();

recintosData.forEach(r=>{
if(r.nombre.toLowerCase().includes(texto)){
r.marker.setStyle({opacity:1,fillOpacity:0.9});
}else{
r.marker.setStyle({opacity:0.2,fillOpacity:0.2});
}
});

});

</script>
</body>
</html>