<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Sistema Electoral 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.7/wicket.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.7/wicket-leaflet.min.js"></script>

<style>
body { margin:0; display:flex; font-family:Arial; overflow:hidden; }
#map { width:75%; height:100vh; }
#dashboard {
width:25%;
background:#1e1e1e;
color:white;
padding:15px;
overflow:hidden;
}
#rankingRecintos{
max-height:300px;
overflow-y:auto;
margin-top:10px;
border-top:1px solid #444;
padding-top:10px;
}
#controls{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
z-index:1000;
background:white;
padding:12px;
border-radius:8px;
box-shadow:0 0 10px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div id="controls">
<b>Sistema Electoral 2026</b><br>
INFORMACION BORIS RAMIREZ
</div>

<div id="map"></div>

<div id="dashboard">
<h3>ðŸ“Š Dashboard</h3>
<b>Total Recintos:</b>
<div id="totalRecintos">0</div>
<b>Total Habilitados:</b>
<div id="totalHabilitados">0</div>
<hr>
<b>Ranking</b>
<div id="rankingRecintos"></div>
</div>

<script>

var map=L.map('map').setView([-17.7833,-63.1821],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

var layerUV=L.layerGroup().addTo(map);
var layerRecintos=L.layerGroup().addTo(map);

var recintos=[];

// ===== FUNCIONES =====
function extraerNumeroDistrito(texto){
if(!texto) return null;
let m=texto.toString().match(/\d+/);
return m?parseInt(m[0]):null;
}

function colorDistrito(numero){
let colores=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
"#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf",
"#8B0000","#006400","#00008B","#FF8C00","#4B0082"];
return colores[(numero-1)%colores.length];
}

function colorUV(p){
if(p<=500) return "#ffe5e5";
if(p<=3500) return "#ff9999";
if(p<=7000) return "#ff4d4d";
if(p<=12000) return "#cc0000";
return "#660000";
}

// ===== CARGAR UV =====
fetch("csvjsondistritos.json?v=" + Date.now())
.then(res=>res.json())
.then(data=>{
console.log("UV cargadas:", data.length);

data.forEach(item=>{
if(!item.WKT) return;

let w=new Wkt.Wkt();
w.read(item.WKT);

let poblacion=parseInt(item.poblacion)||0;
let distritoNum=extraerNumeroDistrito(item.distrito);

let poly=w.toObject({
color:distritoNum?colorDistrito(distritoNum):"#000",
weight:2,
fillColor:colorUV(poblacion),
fillOpacity:0.75
});

poly.bindPopup(`
<b>UV: ${item.zona||"-"}</b><br>
Distrito: ${item.distrito||"-"}<br>
Habitantes: ${poblacion.toLocaleString()}
`);

poly.addTo(layerUV);
});
})
.catch(e=>console.error("Error UV:",e));

// ===== CARGAR RECINTOS =====
fetch("recintos2026.json?v=" + Date.now())
.then(res=>res.json())
.then(data=>{

console.log("Recintos cargados:", data.length);

let bounds=[];

data.forEach(row=>{

let lat=parseFloat(row.Latitud);
let lng=parseFloat(row.Longitud);

if(isNaN(lat)||isNaN(lng)) return;

let hab=Number(row.Habilitados2026)||0;
let radio=Math.max(5,Math.sqrt(hab)/3);

let distritoNum=extraerNumeroDistrito(row.Distrito);
let color=distritoNum?colorDistrito(distritoNum):"#FFD700";

let marker=L.circleMarker([lat,lng],{
radius:radio,
fillColor:color,
color:color,
fillOpacity:0.9
}).addTo(layerRecintos);

marker.bindPopup(`
<b>${row.Recinto}</b><br>
Distrito: ${row.Distrito||"-"}<br>
Habilitados: ${hab.toLocaleString()}
`);

recintos.push(marker);
bounds.push([lat,lng]);

});

if(bounds.length>0){
map.fitBounds(bounds);
}

actualizarDashboard();

})
.catch(e=>console.error("Error recintos:",e));

// ===== DASHBOARD =====
function actualizarDashboard(){
let total=0;
recintos.forEach(m=>{
let txt=m.getPopup().getContent();
let match=txt.match(/Habilitados: ([\d,]+)/);
if(match) total+=Number(match[1].replace(/,/g,""));
});
document.getElementById("totalRecintos").innerHTML=recintos.length;
document.getElementById("totalHabilitados").innerHTML=total.toLocaleString();
}

</script>
</body>
</html>