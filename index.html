<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Mapa Electoral 2026</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  #map {
    height: 100vh;
  }

  .control-box {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    width: 280px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  }

  .control-box input {
    width: 100%;
    padding: 6px;
    margin-bottom: 6px;
  }

  .suggestions {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
  }

  .suggestion-item {
    padding: 6px;
    cursor: pointer;
  }

  .suggestion-item:hover {
    background: #f0f0f0;
  }
</style>
</head>

<body>

<div class="control-box">

<select id="filtro">
  <option value="TODOS">Todos</option>
  <option value="CON2021">CON2021</option>
  <option value="Dip20251V">Dip20251V</option>
  <option value="20252V">20252V</option>
</select>

<input type="text" id="buscador" placeholder="Buscar recinto...">

<div id="suggestions" class="suggestions"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// ================= MAPA =================

var map = L.map('map').setView([-17.78, -63.18], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

var puntosLayer = L.layerGroup().addTo(map);
var poligonosLayer = L.layerGroup().addTo(map);

var datosPuntos;
var marcadorSeleccionado = null;


// ================= FUNCIONES =================

function getRadio(valor) {
  if (!valor) return 4;
  return Math.sqrt(valor) * 0.6;
}

function getColor(valor) {
  if (valor > 60) return "#1a9641";
  if (valor > 40) return "#a6d96a";
  if (valor > 20) return "#fdae61";
  return "#d7191c";
}


// ================= DIBUJAR PUNTOS =================

function dibujarPuntos(filtro) {

  puntosLayer.clearLayers();

  L.geoJSON(datosPuntos, {

    pointToLayer: function(feature, latlng) {

      let radio = getRadio(feature.properties.Habilitados2026);

      let valorFiltro = 0;
      if (filtro !== "TODOS") {
        valorFiltro = feature.properties[filtro];
      }

      return L.circleMarker(latlng, {
        radius: radio,
        fillColor: filtro === "TODOS" ? "#3388ff" : getColor(valorFiltro),
        color: "#333",
        weight: 1,
        fillOpacity: 0.8
      });
    },

    onEachFeature: function(feature, layer) {

      layer.bindPopup(`
        <b>${feature.properties.NombreRecinto}</b><br>
        Distrito: ${feature.properties.Distrito}<br>
        UV: ${feature.properties.UV}<br>
        Habilitados: ${feature.properties.Habilitados2026}
      `);

      layer.featureId = feature.properties.ID || feature.properties.NombreRecinto;

    }

  }).addTo(puntosLayer);
}


// ================= BUSCADOR INTELIGENTE =================

function normalizarTexto(texto) {
  return texto
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function actualizarSugerencias(texto) {

  let container = document.getElementById("suggestions");
  container.innerHTML = "";

  if (!texto) return;

  let textoNormal = normalizarTexto(texto);

  let coincidencias = datosPuntos.features.filter(f => {

    let nombre = normalizarTexto(f.properties.NombreRecinto);

    return nombre.includes(textoNormal);

  });

  coincidencias.slice(0, 15).forEach(feature => {

    let div = document.createElement("div");
    div.className = "suggestion-item";

    div.innerHTML = `
      <b>${feature.properties.NombreRecinto}</b><br>
      <small>Distrito ${feature.properties.Distrito} - UV ${feature.properties.UV}</small>
    `;

    div.onclick = function() {

      let coords = feature.geometry.coordinates;
      let latlng = [coords[1], coords[0]];

      map.setView(latlng, 16);

      if (marcadorSeleccionado) {
        map.removeLayer(marcadorSeleccionado);
      }

      marcadorSeleccionado = L.circleMarker(latlng, {
        radius: 12,
        color: "yellow",
        weight: 3,
        fillOpacity: 0.3
      }).addTo(map);

      container.innerHTML = "";
      document.getElementById("buscador").value = feature.properties.NombreRecinto;

    };

    container.appendChild(div);

  });

}


// ================= EVENTOS =================

document.getElementById("buscador").addEventListener("input", function() {
  actualizarSugerencias(this.value);
});

document.getElementById("filtro").addEventListener("change", function() {
  dibujarPuntos(this.value);
});


// ================= CARGAR DATOS =================

fetch("puntos.geojson")
.then(res => res.json())
.then(data => {
  datosPuntos = data;
  dibujarPuntos("TODOS");
});

fetch("poligonos.geojson")
.then(res => res.json())
.then(data => {

  L.geoJSON(data, {
    style: {
      color: "#000",
      weight: 1,
      fillColor: "#ff7800",
      fillOpacity: 0.4
    }
  }).addTo(poligonosLayer);

});

</script>

</body>
</html>